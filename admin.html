<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apex Capital — Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400&family=DM+Mono:wght@300;400&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --white: #fafaf8; --black: #111110; --grey-dark: #3a3a38;
      --grey-mid: #8a8a87; --grey-light: #d4d3ce; --border: #e2e1dc;
      --red: #c0392b; --green: #27ae60;
    }
    body { background: var(--white); color: var(--black); font-family: 'EB Garamond', Georgia, serif; font-size: 17px; line-height: 1.6; min-height: 100vh; }

    /* LOGIN */
    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 40px; }
    .login-box { width: 100%; max-width: 400px; }
    .login-logo { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--grey-mid); margin-bottom: 48px; }
    .login-title { font-size: 32px; font-weight: 400; margin-bottom: 8px; }
    .login-sub { font-size: 15px; color: var(--grey-mid); margin-bottom: 40px; }
    .form-group { margin-bottom: 24px; }
    label { display: block; font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--grey-mid); margin-bottom: 8px; }
    input[type="password"], input[type="text"], input[type="date"], textarea, select {
      width: 100%; padding: 12px 16px; border: 1px solid var(--border); background: var(--white);
      font-family: 'EB Garamond', serif; font-size: 17px; color: var(--black); outline: none; transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus { border-color: var(--grey-dark); }
    textarea { resize: vertical; min-height: 280px; line-height: 1.7; }
    select { font-family: 'DM Mono', monospace; font-size: 12px; letter-spacing: 0.06em; }
    .btn { display: inline-block; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.14em; text-transform: uppercase; padding: 12px 28px; border: 1px solid var(--black); background: var(--black); color: var(--white); cursor: pointer; transition: background 0.2s; }
    .btn:hover { background: var(--grey-dark); border-color: var(--grey-dark); }
    .btn-ghost { background: transparent; color: var(--black); }
    .btn-ghost:hover { background: #f0efeb; color: var(--black); }
    .btn-danger { background: transparent; color: var(--red); border-color: var(--red); }
    .btn-danger:hover { background: var(--red); color: var(--white); }
    .btn-sm { padding: 7px 16px; font-size: 10px; }
    .error-msg { color: var(--red); font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.08em; margin-top: 12px; }
    .success-msg { color: var(--green); font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.08em; }

    /* ADMIN */
    .admin { display: none; }
    .admin.active { display: flex; min-height: 100vh; }
    .sidebar { width: 230px; min-width: 230px; border-right: 1px solid var(--border); padding: 32px 0; display: flex; flex-direction: column; position: sticky; top: 0; height: 100vh; overflow-y: auto; }
    .sidebar-logo { font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--grey-mid); padding: 0 28px; margin-bottom: 40px; }
    .sidebar-section { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.2em; text-transform: uppercase; color: var(--grey-light); padding: 0 28px; margin-bottom: 8px; }
    .sidebar-nav { list-style: none; margin-bottom: 32px; }
    .sidebar-nav li a { display: block; padding: 10px 28px; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--grey-mid); text-decoration: none; transition: color 0.2s, background 0.2s; cursor: pointer; }
    .sidebar-nav li a:hover { color: var(--black); background: #f0efeb; }
    .sidebar-nav li a.active { color: var(--black); }
    .sidebar-footer { margin-top: auto; padding: 0 28px; display: flex; flex-direction: column; gap: 12px; }
    .sidebar-footer a { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.12em; text-transform: uppercase; color: var(--grey-mid); text-decoration: none; cursor: pointer; transition: color 0.2s; }
    .sidebar-footer a:hover { color: var(--black); }
    .main-content { flex: 1; overflow-y: auto; }
    .panel { display: none; padding: 60px; }
    .panel.active { display: block; }
    .panel-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 48px; padding-bottom: 32px; border-bottom: 1px solid var(--border); }
    .panel-title { font-size: 36px; font-weight: 400; letter-spacing: -0.01em; }

    /* STATS */
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: var(--border); margin-bottom: 60px; }
    .stat-card { background: var(--white); padding: 36px; }
    .stat-label { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--grey-mid); margin-bottom: 12px; }
    .stat-value { font-size: 40px; font-weight: 400; line-height: 1; }

    /* TABLE */
    .posts-table { width: 100%; border-collapse: collapse; }
    .posts-table th { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.18em; text-transform: uppercase; color: var(--grey-mid); text-align: left; padding: 12px 0; border-bottom: 1px solid var(--border); }
    .posts-table td { padding: 20px 0; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .posts-table tr:last-child td { border-bottom: none; }
    .post-row-title { font-size: 17px; margin-bottom: 4px; }
    .post-row-meta { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.08em; color: var(--grey-mid); }
    .status-badge { display: inline-block; font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; padding: 4px 10px; border: 1px solid var(--border); color: var(--grey-mid); }
    .status-badge.published { border-color: var(--green); color: var(--green); }
    .row-actions { display: flex; gap: 8px; }
    .empty-state { padding: 60px 0; font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.1em; color: var(--grey-mid); }

    /* EDITOR */
    .editor-form { max-width: 760px; }
    .editor-row { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    .form-hint { font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 0.08em; color: var(--grey-mid); margin-top: 6px; }
    .editor-actions { display: flex; gap: 16px; align-items: center; margin-top: 32px; padding-top: 32px; border-top: 1px solid var(--border); }

    .mono-sm { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--grey-mid); letter-spacing: 0.06em; }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <div class="login-logo">Apex Capital</div>
      <h1 class="login-title">Admin access</h1>
      <p class="login-sub">Enter your password to continue.</p>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="passwordInput" placeholder="••••••••" />
      </div>
      <button class="btn" onclick="attemptLogin()">Sign in →</button>
      <div class="error-msg" id="loginError" style="display:none;">Incorrect password.</div>
    </div>
  </div>

  <!-- ADMIN -->
  <div class="admin" id="adminPanel">
    <aside class="sidebar">
      <div class="sidebar-logo">Apex Admin</div>
      <div class="sidebar-section">Content</div>
      <ul class="sidebar-nav">
        <li><a onclick="showPanel('dashboard')" id="nav-dashboard" class="active">Dashboard</a></li>
        <li><a onclick="showPanel('posts')" id="nav-posts">All Posts</a></li>
        <li><a onclick="showPanel('new')" id="nav-new">New Post</a></li>
      </ul>
      <div class="sidebar-footer">
        <a href="index.html" target="_blank">← View site</a>
        <a onclick="logout()">Sign out</a>
      </div>
    </aside>

    <main class="main-content">

      <!-- Dashboard -->
      <div class="panel active" id="panel-dashboard">
        <div class="panel-header">
          <h1 class="panel-title">Dashboard</h1>
        </div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">Total Posts</div><div class="stat-value" id="statTotal">—</div></div>
          <div class="stat-card"><div class="stat-label">Published</div><div class="stat-value" id="statPublished">—</div></div>
          <div class="stat-card"><div class="stat-label">Total Views</div><div class="stat-value" id="statViews">—</div></div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
          <div class="mono-sm" style="font-size:10px; letter-spacing:0.18em; text-transform:uppercase;">Recent Posts</div>
          <button class="btn btn-sm" onclick="showPanel('new')">+ New Post</button>
        </div>
        <div id="recentPosts"></div>
      </div>

      <!-- All Posts -->
      <div class="panel" id="panel-posts">
        <div class="panel-header">
          <h1 class="panel-title">All Posts</h1>
          <button class="btn btn-sm" onclick="showPanel('new')">+ New Post</button>
        </div>
        <div id="allPostsList"></div>
      </div>

      <!-- Editor -->
      <div class="panel" id="panel-new">
        <div class="panel-header">
          <h1 class="panel-title" id="editorTitle">New Post</h1>
        </div>
        <div class="editor-form">
          <input type="hidden" id="editId" />
          <div class="form-group">
            <label>Title</label>
            <input type="text" id="postTitle" placeholder="Post title" />
          </div>
          <div class="editor-row">
            <div class="form-group">
              <label>Category</label>
              <input type="text" id="postCategory" placeholder="e.g. Markets, Macro, Company" />
            </div>
            <div class="form-group">
              <label>Date</label>
              <input type="date" id="postDate" />
            </div>
          </div>
          <div class="form-group">
            <label>Excerpt <span style="text-transform:none; letter-spacing:0; font-weight:300;">(optional)</span></label>
            <input type="text" id="postExcerpt" placeholder="Short preview shown on homepage" />
          </div>
          <div class="form-group">
            <label>Body</label>
            <textarea id="postBody" placeholder="Write your post here. Separate paragraphs with a blank line."></textarea>
            <div class="form-hint">Separate paragraphs with a blank line (double Enter)</div>
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="postStatus">
              <option value="false">Draft — not visible on site</option>
              <option value="true">Published — visible on site</option>
            </select>
          </div>
          <div class="editor-actions">
            <button class="btn" onclick="savePost()">Save Post</button>
            <button class="btn btn-ghost" onclick="clearEditor()">Clear</button>
            <span class="success-msg" id="saveMsg" style="display:none;"></span>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script>
    // ── CONFIG — change this password! ──
    const ADMIN_PASSWORD = 'apexadmin2026';
    const SUPABASE_URL = 'https://gmhpcrjeggrmgrmxdrac.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtaHBjcmplZ2dybWdybXhkcmFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNTAzMTQsImV4cCI6MjA4NjYyNjMxNH0.0n32mCi_y02dSpHg_hs7yse1WXcXnlydwO9nBBQUA1I';

    // ── Supabase REST client ──
    const db = {
      h: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      },
      async select(query) {
        const r = await fetch(`${SUPABASE_URL}/rest/v1/${query}`, { headers: this.h });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      },
      async insert(table, data) {
        const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, { method: 'POST', headers: this.h, body: JSON.stringify(data) });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      },
      async update(table, id, data) {
        const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, { method: 'PATCH', headers: this.h, body: JSON.stringify(data) });
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      },
      async delete(table, id) {
        const r = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, { method: 'DELETE', headers: this.h });
        if (!r.ok) throw new Error(await r.text());
      }
    };

    // ── Auth ──
    function attemptLogin() {
      if (document.getElementById('passwordInput').value === ADMIN_PASSWORD) {
        sessionStorage.setItem('apex_auth', '1');
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').classList.add('active');
        refreshDashboard();
      } else {
        document.getElementById('loginError').style.display = 'block';
      }
    }
    document.getElementById('passwordInput').addEventListener('keydown', e => { if (e.key === 'Enter') attemptLogin(); });

    function logout() { sessionStorage.removeItem('apex_auth'); location.reload(); }

    if (sessionStorage.getItem('apex_auth')) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminPanel').classList.add('active');
      refreshDashboard();
    }

    // ── Navigation ──
    function showPanel(name) {
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
      document.getElementById('panel-' + name).classList.add('active');
      document.getElementById('nav-' + name).classList.add('active');
      if (name === 'dashboard') refreshDashboard();
      if (name === 'posts') refreshPostsList();
      if (name === 'new' && !document.getElementById('editId').value) {
        document.getElementById('postDate').value = new Date().toISOString().slice(0, 10);
      }
    }

    // ── Helpers ──
    function formatDate(iso) {
      try { return new Date(iso).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }); }
      catch { return iso; }
    }

    function showMsg(msg, isError = false) {
      const el = document.getElementById('saveMsg');
      el.textContent = msg;
      el.style.color = isError ? '#c0392b' : '#27ae60';
      el.style.display = 'inline';
      setTimeout(() => el.style.display = 'none', 3500);
    }

    function postTableHTML(posts) {
      if (!posts.length) return '<div class="empty-state">No posts yet.</div>';
      return `<table class="posts-table">
        <thead><tr><th>Title</th><th>Status</th><th>Views</th><th>Date</th><th></th></tr></thead>
        <tbody>${posts.map(p => `
          <tr>
            <td><div class="post-row-title">${p.title}</div><div class="post-row-meta">${p.category || '—'}</div></td>
            <td><span class="status-badge ${p.published ? 'published' : ''}">${p.published ? 'Published' : 'Draft'}</span></td>
            <td class="mono-sm">${p.views || 0}</td>
            <td class="mono-sm" style="font-size:10px;">${formatDate(p.date)}</td>
            <td><div class="row-actions">
              <button class="btn btn-ghost btn-sm" onclick="editPost('${p.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="deletePost('${p.id}')">Delete</button>
            </div></td>
          </tr>`).join('')}
        </tbody></table>`;
    }

    // ── Dashboard ──
    async function refreshDashboard() {
      try {
        const posts = await db.select('posts?order=created_at.desc');
        const published = posts.filter(p => p.published);
        const views = posts.reduce((s, p) => s + (p.views || 0), 0);
        document.getElementById('statTotal').textContent = posts.length;
        document.getElementById('statPublished').textContent = published.length;
        document.getElementById('statViews').textContent = views;
        document.getElementById('recentPosts').innerHTML = postTableHTML(posts.slice(0, 5));
      } catch (e) {
        document.getElementById('recentPosts').innerHTML = `<div class="empty-state">Error loading posts: ${e.message}</div>`;
      }
    }

    // ── All Posts ──
    async function refreshPostsList() {
      try {
        const posts = await db.select('posts?order=created_at.desc');
        document.getElementById('allPostsList').innerHTML = postTableHTML(posts);
      } catch (e) {
        document.getElementById('allPostsList').innerHTML = `<div class="empty-state">Error: ${e.message}</div>`;
      }
    }

    // ── Editor ──
    function clearEditor() {
      document.getElementById('editId').value = '';
      document.getElementById('postTitle').value = '';
      document.getElementById('postCategory').value = '';
      document.getElementById('postDate').value = new Date().toISOString().slice(0, 10);
      document.getElementById('postExcerpt').value = '';
      document.getElementById('postBody').value = '';
      document.getElementById('postStatus').value = 'false';
      document.getElementById('editorTitle').textContent = 'New Post';
    }

    async function editPost(id) {
      try {
        const [post] = await db.select(`posts?id=eq.${id}`);
        document.getElementById('editId').value = post.id;
        document.getElementById('postTitle').value = post.title;
        document.getElementById('postCategory').value = post.category || '';
        document.getElementById('postDate').value = post.date;
        document.getElementById('postExcerpt').value = post.excerpt || '';
        document.getElementById('postBody').value = post.body;
        document.getElementById('postStatus').value = post.published ? 'true' : 'false';
        document.getElementById('editorTitle').textContent = 'Edit Post';
        showPanel('new');
      } catch (e) { alert('Could not load post: ' + e.message); }
    }

    async function savePost() {
      const title = document.getElementById('postTitle').value.trim();
      const body = document.getElementById('postBody').value.trim();
      if (!title) { showMsg('Please enter a title.', true); return; }
      if (!body) { showMsg('Please enter content.', true); return; }

      const data = {
        title,
        category: document.getElementById('postCategory').value.trim() || null,
        date: document.getElementById('postDate').value || new Date().toISOString().slice(0, 10),
        excerpt: document.getElementById('postExcerpt').value.trim() || null,
        body,
        published: document.getElementById('postStatus').value === 'true'
      };

      const id = document.getElementById('editId').value;
      try {
        if (id) {
          await db.update('posts', id, data);
          showMsg('Post updated ✓');
        } else {
          const [newPost] = await db.insert('posts', data);
          document.getElementById('editId').value = newPost.id;
          document.getElementById('editorTitle').textContent = 'Edit Post';
          showMsg('Post saved ✓');
        }
      } catch (e) { showMsg('Error: ' + e.message, true); }
    }

    async function deletePost(id) {
      if (!confirm('Delete this post permanently?')) return;
      try {
        await db.delete('posts', id);
        refreshDashboard();
        refreshPostsList();
      } catch (e) { alert('Error: ' + e.message); }
    }
  </script>
</body>
</html>
